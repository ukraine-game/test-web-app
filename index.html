<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TG Star Empire v2.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-blue: #24A1DE;
            --bg-color: #0b0f19;
            --card-bg: #161c2c;
            --text-color: #ffffff;
            --accent: #38bdf8;
            --gold: #fbbf24;
            --gray: #94a3b8;
            --red: #ef4444;
            --green: #22c55e;
            --input-bg: #1e293b;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }

        .container { display: flex; flex-direction: column; height: 100vh; }
        
        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: fixed; inset: 0; z-index: 2000;
            background: var(--bg-color);
            padding: 40px; text-align: center;
        }
        .auth-card {
            background: var(--card-bg); padding: 30px 20px;
            border-radius: 20px; border: 1px solid #2d3748;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .auth-input {
            width: 100%; box-sizing: border-box;
            background: var(--input-bg); border: 1px solid #334155;
            color: white; padding: 12px; border-radius: 10px;
            margin-bottom: 15px; font-size: 16px; outline: none;
        }
        .auth-input:focus { border-color: var(--tg-blue); }
        .btn-primary {
            background: var(--tg-blue); color: white; border: none;
            padding: 12px; border-radius: 10px; font-weight: bold;
            width: 100%; cursor: pointer; font-size: 16px;
        }

        /* --- HEADER & STATS --- */
        .header {
            padding: 12px 20px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(22, 28, 44, 0.95); border-bottom: 1px solid #2d3748;
            z-index: 10;
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(45deg, var(--tg-blue), #60a5fa);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid #3b82f6; overflow: hidden;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .rank-badge {
            font-size: 9px; background: var(--tg-blue); padding: 1px 6px;
            border-radius: 6px; text-transform: uppercase; font-weight: 800;
            margin-top: 2px; display: inline-block;
        }

        .score-section { text-align: center; padding: 20px 0; }
        .score-main { 
            font-size: 42px; font-weight: 900; color: white;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* --- GAME CONTENT --- */
        .content { flex-grow: 1; overflow-y: auto; padding-bottom: 120px; }
        .tab-content { display: none; padding: 0 20px; animation: slideUp 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .tap-box { display: flex; justify-content: center; align-items: center; height: 260px; margin: 10px 0; }
        .tg-coin {
            width: 220px; height: 220px; cursor: pointer;
            transition: transform 0.05s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 0 30px rgba(36, 161, 222, 0.2));
        }
        .tg-coin:active { transform: scale(0.95); }

        .stats-wrap { background: var(--card-bg); padding: 15px; border-radius: 20px; margin-bottom: 10px; border: 1px solid #2d3748; }
        .progress-container { height: 10px; background: #1e293b; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); width: 100%; transition: width 0.2s; }

        .card {
            background: var(--card-bg); padding: 14px; border-radius: 18px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; border: 1px solid #2d3748;
            transition: all 0.3s ease;
        }

        /* make upgrade and task cards slightly narrower and centered */
        #tab-upgrades .card,
        #tab-tasks .card {
            max-width: 86%;
            margin: 8px auto;
            padding: 10px 12px;
        }

        .card.buy-success { border-color: var(--green); box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); transform: scale(1.02); }
        .card.buy-fail { border-color: var(--red); animation: shake 0.4s ease-in-out; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        .card.completed { border-color: var(--gray); opacity: 0.6; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .btn-upgrade, .btn-task {
            background: var(--tg-blue); color: white; border: none;
            padding: 10px 12px; border-radius: 10px; font-weight: bold; min-width: 80px;
        }
        .btn-red { background: var(--red); color: white; }

        /* --- ADMIN & OVERLAYS --- */
        #ban-screen {
            position: fixed; inset: 0; background: #000; color: white;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10000; text-align: center; padding: 20px;
        }
        #admin-auth-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 3000; padding: 20px;
        }
        
        .admin-panel-ui {
            background: #1e293b; border-radius: 15px; padding: 15px;
            margin-top: 15px; border: 1px dashed var(--gold); display: none;
        }
        .user-list-table {
            width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px;
        }
        .user-list-table th { text-align: left; color: var(--gray); border-bottom: 1px solid #334155; padding: 5px; }
        .user-list-table td { padding: 5px; border-bottom: 1px solid #334155; }
        .user-list-table tr:last-child td { border-bottom: none; }

        /* --- NAVIGATION --- */
        .nav {
            position: fixed; bottom: 0; width: 100%; display: flex;
            background: #111827; padding: 10px 0 25px; border-top: 1px solid #1e293b;
            z-index: 100;
        }
        .nav-item { flex: 1; text-align: center; font-size: 10px; color: #64748b; cursor: pointer; padding-top: 5px; }
        .nav-item.active { color: var(--tg-blue); font-weight: bold; }

        .float-text {
            position: absolute; color: white; font-weight: 800; font-size: 28px;
            pointer-events: none; animation: popUp 0.7s ease-out forwards;
            z-index: 100; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        @keyframes popUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }
    </style>
</head>
<body>

<div id="ban-screen">
    <h1 style="color: var(--red); font-size: 32px; font-weight: 900;">üö´ –î–û–°–¢–£–ü –ó–ê–ë–õ–û–ö–û–í–ê–ù–û</h1>
    <p>–í–∞—à –∞–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∑–∞ –ø–æ—Ä—É—à–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª.</p>
</div>

<div id="auth-screen" class="flex flex-col center">
    <div class="auth-card">
        <h2 style="margin-bottom: 20px; color: var(--tg-blue);">Star Empire ID</h2>
        <input type="text" id="login-user" class="auth-input" placeholder="–õ–æ–≥—ñ–Ω / Username">
        <input type="password" id="login-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
        <!-- new: display name input for registration -->
        <input type="text" id="display-name" class="auth-input" placeholder="–ù—ñ–∫–Ω–µ–π–º (–≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ—ñ–ª—ñ)" maxlength="32">
        <button class="btn-primary" onclick="Auth.attemptLogin()">–£–≤—ñ–π—Ç–∏ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
        <p style="font-size: 11px; color: var(--gray); margin-top: 15px;">
            –Ø–∫—â–æ –∞–∫–∞—É–Ω—Ç—É –Ω–µ–º–∞—î, –≤—ñ–Ω –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.
        </p>
    </div>
</div>

<div id="admin-auth-overlay">
    <h3 style="color: var(--gold)">–î–æ—Å—Ç—É–ø —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞</h3>
    <input type="password" id="admin-pass-input" class="auth-input" style="width: 80%; text-align: center;" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥...">
    <button class="btn-primary" style="width: 80%" onclick="Admin.checkAccess()">–£–≤—ñ–π—Ç–∏</button>
    <button style="background: none; border: none; color: var(--gray); margin-top: 15px;" onclick="Admin.closeOverlay()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
</div>

<!-- Add avatar picker overlay (hidden by default) -->
<div id="avatar-picker" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:4000; align-items:center; justify-content:center; padding:20px;">
    <div style="background:var(--card-bg); padding:20px; border-radius:12px; width:320px; text-align:center; border:1px solid #334155;">
        <h3 style="color:var(--gold); margin:0 0 10px;">–û–±–µ—Ä—ñ—Ç—å –∞–≤–∞—Ç–∞—Ä</h3>
        <input id="avatar-file-input" type="file" accept="image/*" style="width:100%; margin-bottom:10px;">
        <div style="display:flex; gap:8px; justify-content:center;">
            <button class="btn-primary" onclick="Auth.uploadAvatar()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
            <button style="background:none; border:none; color:var(--gray);" onclick="Auth.skipAvatar()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
        </div>
    </div>
</div>

<div class="container hidden" id="main-app-container">
    <div class="header">
        <div class="user-info">
            <div id="u-avatar" class="avatar">?</div>
            <div>
                <div id="u-name-head" style="font-size: 14px; font-weight: bold;">User</div>
                <div id="u-rank-head" class="rank-badge">–ù–æ–≤–∞—á–æ–∫</div>
            </div>
        </div>
        <div style="background: #1e293b; padding: 6px 14px; border-radius: 12px; font-size: 14px; font-weight: 800; color: var(--gold);">
            üí∞ <span id="h-bal">0</span>
        </div>
    </div>

    <div class="content">
        <div id="tab-main" class="tab-content active">
            <div class="score-section">
                <div class="score-label">–¢–≤—ñ–π –∫–∞–ø—ñ—Ç–∞–ª</div>
                <div class="score-main">
                    <img src="https://telegram.org/img/t_logo.png" width="35">
                    <span id="m-bal">0</span>
                </div>
                <div style="height: 35px; display: flex; justify-content: center; align-items: center;">
                    <div id="p-income-text" style="font-size: 12px; color: var(--accent); background: rgba(56,189,248,0.1); padding: 4px 10px; border-radius: 15px; display: none;"></div>
                </div>
            </div>
            <div class="tap-box">
                <img src="https://telegram.org/img/t_logo.png" id="tap-coin" class="tg-coin">
            </div>
            <div class="stats-wrap">
                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                    <span>‚ö° –ï–Ω–µ—Ä–≥—ñ—è</span>
                    <span id="e-val">200 / 200</span>
                </div>
                <div class="progress-container">
                    <div id="e-bar" class="progress-fill"></div>
                </div>
            </div>
        </div>

        <div id="tab-upgrades" class="tab-content">
            <h3 style="margin: 20px 0 15px;">–ú–∞–≥–∞–∑–∏–Ω –ø–æ–∫—Ä–∞—â–µ–Ω—å</h3>
            <div class="card" id="card-auto">
                <div class="card-info">
                    <h4>Auto-Clicker ü§ñ</h4>
                    <p id="auto-desc">–ü–∞—Å–∏–≤–Ω–∏–π –¥–æ—Ö—ñ–¥</p>
                    <p>–¶—ñ–Ω–∞: <span id="cost-auto">1000</span></p>
                </div>
                <button class="btn-upgrade" onclick="Shop.buy('auto')">Lvl <span id="lv-auto">0</span></button>
            </div>
            <div class="card" id="card-tap">
                <div class="card-info">
                    <h4>–°–∏–ª–∞ —Ç–∞–ø—É üí™</h4>
                    <p id="tap-desc">+1 –∑–∞ –∫–ª—ñ–∫</p>
                    <p>–¶—ñ–Ω–∞: <span id="cost-tap">100</span></p>
                </div>
                <button class="btn-upgrade" onclick="Shop.buy('tap')">–ö—É–ø–∏—Ç–∏</button>
            </div>
            <div class="card" id="card-energy">
                <div class="card-info">
                    <h4>–ï–Ω–µ—Ä–≥–æ-–±—É—Å—Ç üîã</h4>
                    <p>+100 –¥–æ –ª—ñ–º—ñ—Ç—É</p>
                    <p>–¶—ñ–Ω–∞: <span id="cost-energy">100</span></p>
                </div>
                <button class="btn-upgrade" onclick="Shop.buy('energy')">–ö—É–ø–∏—Ç–∏</button>
            </div>
            <div class="card" id="card-regen">
                <div class="card-info">
                    <h4>–†–µ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è ‚ö°</h4>
                    <p>–®–≤–∏–¥–∫—ñ—Å—Ç—å –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è</p>
                    <p>–¶—ñ–Ω–∞: <span id="cost-regen">200</span></p>
                </div>
                <button class="btn-upgrade" onclick="Shop.buy('regen')">Lvl <span id="lv-regen">1</span></button>
            </div>
        </div>

        <div id="tab-tasks" class="tab-content">
            <h3 style="margin: 20px 0 15px;">–ó–∞–≤–¥–∞–Ω–Ω—è</h3>
            <div id="task-list"></div>
        </div>

        <div id="tab-profile" class="tab-content">
            <h3 style="margin: 20px 0 15px;">–ö–∞–±—ñ–Ω–µ—Ç</h3>
            <div class="card" style="flex-direction: column; align-items: flex-start; gap: 12px; padding: 20px;">
                <div style="width:100%; display:flex; justify-content:space-between; border-bottom:1px solid #2d3748; padding-bottom:8px;">
                    <span style="color:var(--gray)">–ì—Ä–∞–≤–µ—Ü—å:</span>
                    <span id="p-name" style="font-weight:bold">-</span>
                </div>
                <div style="width:100%; display:flex; justify-content:space-between;">
                    <span style="color:var(--gray)">Game ID:</span>
                    <span id="p-game-id" style="font-family:monospace; color:var(--gold); cursor:pointer; font-weight:bold;" onclick="Admin.handleSecretClick()">#---</span>
                </div>
                <button class="btn-upgrade btn-red" style="width: 100%; margin-top: 10px;" onclick="Auth.logout()">–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</button>
            </div>

            <div id="admin-panel" class="admin-panel-ui">
                <h4 style="margin: 0 0 10px; color: var(--gold); text-align: center;">‚öôÔ∏è ADMIN DASHBOARD</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table class="user-list-table">
                        <thead>
                            <tr><th>User</th><th>Balance</th><th>Lvl</th></tr>
                        </thead>
                        <tbody id="admin-users-list"></tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; border-top: 1px solid #334155; padding-top: 10px;">
                     <!-- changed: amount input instead of target username -->
                     <input type="number" id="admin-amount-field" class="auth-input" style="padding: 6px; font-size: 12px;" placeholder="–°—É–º–∞..." min="0" step="1">
                     <div style="display: grid; grid-template-columns: repeat(2,1fr); gap: 6px; margin-top:8px;">
                         <button class="btn-upgrade" onclick="Admin.action('add')">–í–∏–¥–∞—á–∞</button>
                         <button class="btn-upgrade btn-red" onclick="Admin.action('sub')">–ó–∞–±—Ä–∞—Ç–∏</button>
                         <button class="btn-upgrade" onclick="Admin.action('set')">–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏</button>
                         <button class="btn-upgrade btn-red" onclick="Admin.action('ban')">–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è</button>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="Tabs.show('main', this)">üè† –ì—Ä–∞</div>
        <div class="nav-item" onclick="Tabs.show('upgrades', this)">üöÄ –ê–ø–≥—Ä–µ–π–¥–∏</div>
        <div class="nav-item" onclick="Tabs.show('tasks', this)">üìã –ó–∞–≤–¥–∞–Ω–Ω—è</div>
        <div class="nav-item" onclick="Tabs.show('profile', this)">üë§ –ü—Ä–æ—Ñ—ñ–ª—å</div>
    </div>
</div>

<script>
    /**
     * MOCK BACKEND SERVICE
     * –í —Ä–µ–∞–ª—å–Ω–æ–º—É –ø—Ä–æ—î–∫—Ç—ñ —Ü–µ–π –∫–ª–∞—Å –±—É–¥–µ —Ä–æ–±–∏—Ç–∏ –∑–∞–ø–∏—Ç–∏ fetch() –¥–æ API.
     * –ó–∞—Ä–∞–∑ –≤—ñ–Ω —ñ–º—ñ—Ç—É—î –±–∞–∑—É –¥–∞–Ω–∏—Ö, –∑–±–µ—Ä—ñ–≥–∞—é—á–∏ –∑–∞–≥–∞–ª—å–Ω–∏–π –æ–±'—î–∫—Ç —É LocalStorage,
     * —â–æ–± –¥–∞–Ω—ñ –Ω–µ –∑–Ω–∏–∫–∞–ª–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏, –∞–ª–µ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–æ —Ü–µ Backend.
     */
    class FakeBackend {
        constructor() {
            this.dbKey = 'server_database_v2';
            this.db = JSON.parse(localStorage.getItem(this.dbKey)) || { users: [] };
        }

        _saveDb() {
            localStorage.setItem(this.dbKey, JSON.stringify(this.db));
        }

        // updated: accept optional displayName for new user registration
        async login(username, password, displayName = null) {
            await new Promise(r => setTimeout(r, 400));
            
            let user = this.db.users.find(u => u.username === username);
            let isNew = false;
            
            if (!user) {
                // create unique id (guaranteed by checking collisions)
                let newId;
                do {
                    newId = Math.floor(100000 + Math.random() * 900000);
                } while (this.db.users.some(u => u.id === newId));

                user = {
                    username, password,
                    id: newId,
                    displayName: displayName || username,
                    bal: 0, energy: 200, maxEnergy: 200,
                    power: 1, regen: 1, autoLvl: 0,
                    isBanned: false,
                    lastTime: Date.now(),
                    completedTasks: [],
                    avatar: null // store data URL when uploaded
                };
                this.db.users.push(user);
                this._saveDb();
                isNew = true;
            } else {
                if (user.password !== password) throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å");
                if (user.isBanned) throw new Error("BANNED");
            }

            return { token: `token_${user.username}`, data: user, isNew };
        }

        async sync(token, currentState) {
            const username = token.replace('token_', '');
            const idx = this.db.users.findIndex(u => u.username === username);
            if (idx !== -1) {
                // only persist allowed fields to DB
                const keep = { bal: currentState.bal, energy: currentState.energy, maxEnergy: currentState.maxEnergy,
                    power: currentState.power, regen: currentState.regen, autoLvl: currentState.autoLvl,
                    lastTime: currentState.lastTime, completedTasks: currentState.completedTasks, isBanned: currentState.isBanned,
                    avatar: currentState.avatar || this.db.users[idx].avatar
                };
                this.db.users[idx] = { ...this.db.users[idx], ...keep };
                this._saveDb();
                return true;
            }
            return false;
        }

        async getAllUsers() {
            return this.db.users.map(u => ({
                username: u.username,
                bal: u.bal,
                autoLvl: u.autoLvl,
                isBanned: u.isBanned
            }));
        }

        async banUser(targetUsername) {
            const user = this.db.users.find(u => u.username === targetUsername);
            if (user) {
                user.isBanned = true;
                this._saveDb();
                return true;
            }
            return false;
        }
        
        async addMoney(targetUsername, amount) {
             const user = this.db.users.find(u => u.username === targetUsername);
             if (user) {
                 user.bal += amount;
                 this._saveDb();
                 return true;
             }
             return false;
        }
    }

    // --- GAME CONSTANTS ---
    const CONFIG = {
        autoIntervals: [0, 5, 4, 3, 2, 1, 0.5],
        autoCosts: [1000, 7000, 20000, 65000, 150000, 400000],
        tapCosts: [100, 250, 400, 700, 1000, 1250, 2000, 5000],
        regenBase: 400,
        energyStep: 600
    };

    const TASKS_DATA = [
        // merged tasks from previous versions
        { id: 1, text: "–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ —Ç–≥–∫: @capuchinor", link: "https://t.me/capuchinor", reward: 4000 },
        { id: 2, text: "–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ —Ç–≥–∫: @jockeeua", link: "https://t.me/jockeeua", reward: 5000 },
        { id: 3, text: "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞: @notcoin_bot", link: "https://t.me/notcoin_bot", reward: 2000 },
        { id: 4, text: "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞: @tribute", link: "https://t.me/tribute", reward: 2000 },
        { id: 5, text: "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞: @GiftsBattle_bot", link: "https://t.me/GiftsBattle_bot?start=_tgr_yfW0szM5N2Ri", reward: 2000 },
        { id: 6, text: "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞: @tapswap_bot", link: "https://t.me/tapswap_bot", reward: 2000 },
        { id: 7, text: "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞: @usinfobot", link: "https://t.me/usinfobot", reward: 2000 },
        // tasks from v2 snapshot kept too
        { id: 8, text: "–ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª", reward: 5000 },
        { id: 9, text: "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞", reward: 2000 },
        { id: 10, text: "–ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –¥—Ä—É–≥–∞", reward: 10000 }
    ];

    // --- STATE MANAGEMENT ---
    const Server = new FakeBackend();
    
    let Game = {
        state: null,
        token: null,
        timer: null,
        syncTimer: null,
        
        init: async function() {
            const savedToken = localStorage.getItem('auth_token');
            if (savedToken) {
                // –°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ-–ª–æ–≥—ñ–Ω—É
                const username = savedToken.replace('token_', '');
                // –£ —Ä–µ–∞–ª—å–Ω–æ–º—É –¥–æ–¥–∞—Ç–∫—É –º–∏ –± —Ä–æ–±–∏–ª–∏ –∑–∞–ø–∏—Ç /me
                // –¢—É—Ç –º–∏ —Ä–æ–±–∏–º–æ "—Ö–∞–∫" —á–µ—Ä–µ–∑ –ª–æ–≥—ñ–Ω –±–µ–∑ –ø–∞—Ä–æ–ª—é (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø—Ä–∏–∫–ª–∞–¥—É —Å–∏–º—É–ª—è—Ü—ñ—ó)
                // –ê–ª–µ —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ —á–∏—Å—Ç–æ—Ç—É, –º–∏ –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞–π–¥–µ–º–æ —é–∑–µ—Ä–∞ –≤ –ë–î
                const user = Server.db.users.find(u => u.username === username);
                if (user && !user.isBanned) {
                    this.startGame(user, savedToken);
                } else {
                    localStorage.removeItem('auth_token');
                    Auth.show();
                }
            } else {
                Auth.show();
            }
        },

        startGame: function(userData, token) {
            this.state = userData;
            this.token = token;
            
            // ensure lastTime exists
            if(!this.state.lastTime) this.state.lastTime = Date.now();

            this.calcOffline();

            // UI
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');

            // display displayName if present, fallback to username
            const nameToShow = this.state.displayName || this.state.username;
            document.getElementById('p-name').innerText = nameToShow;
            document.getElementById('p-game-id').innerText = "#" + this.state.id;
            document.getElementById('u-name-head').innerText = nameToShow;

            // Avatar from stored data URL if present
            if (this.state.avatar) {
                document.getElementById('u-avatar').innerHTML = `<img src="${this.state.avatar}">`;
            } else {
                document.getElementById('u-avatar').innerText = nameToShow[0].toUpperCase();
            }

            this.renderTasks();
            this.updateUI();

            this.timer = setInterval(() => this.loop(), 100);
            this.syncTimer = setInterval(() => {
                Server.sync(this.token, this.state);
            }, 5000);
        },

        calcOffline: function() {
            const now = Date.now();
            const diffSec = (now - this.state.lastTime) / 1000;
            
            // Regen
            const regenAmount = (this.state.regen / 2) * diffSec;
            this.state.energy = Math.min(this.state.maxEnergy, this.state.energy + regenAmount);

            // Auto-clicker
            if (this.state.autoLvl > 0) {
                const interval = CONFIG.autoIntervals[this.state.autoLvl];
                const profit = Math.floor(diffSec / interval) * this.state.power;
                if (profit > 0) {
                    this.state.bal += profit;
                    // –ú–æ–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ –º–æ–¥–∞–ª–∫—É "–ü–æ–∫–∏ –≤–∞—Å –Ω–µ –±—É–ª–æ..."
                }
            }
            this.state.lastTime = now;
        },

        loop: function() {
            if (!this.state) return;
            // Passive logic
            if (this.state.autoLvl > 0) {
                this.state.bal += (this.state.power / (CONFIG.autoIntervals[this.state.autoLvl] * 10));
            }
            if (this.state.energy < this.state.maxEnergy) {
                this.state.energy = Math.min(this.state.maxEnergy, this.state.energy + (this.state.regen / 20));
            }
            
            this.updateUI();
        },

        updateUI: function() {
            const s = this.state;
            const balFloored = Math.floor(s.bal);
            
            document.getElementById('h-bal').innerText = balFloored.toLocaleString();
            document.getElementById('m-bal').innerText = balFloored.toLocaleString();
            document.getElementById('e-val').innerText = `${Math.floor(s.energy)} / ${s.maxEnergy}`;
            document.getElementById('e-bar').style.width = (s.energy / s.maxEnergy * 100) + '%';
            
            // Proper rank thresholds
            function getRank(bal) {
                if (bal < 5000) return "–ù–æ–≤–∞—á–æ–∫";
                if (bal < 15000) return "–î–æ—Å–≤—ñ–¥—á–µ–Ω–∏–π";
                if (bal < 50000) return "–ë—ñ–∑–Ω–µ—Å–º–µ–Ω";
                if (bal < 70000) return "–ü—Ä–æ—Ñ.–ë—ñ–∑–Ω–µ—Å–º–µ–Ω";
                return "–í–ª–∞—Å–Ω–∏–∫";
            }
            document.getElementById('u-rank-head').innerText = getRank(s.bal);

            // Auto text
            const inc = document.getElementById('p-income-text');
            if (s.autoLvl > 0) {
                inc.style.display = 'block';
                inc.innerText = `ü§ñ +${s.power} / ${CONFIG.autoIntervals[s.autoLvl]}s`;
            } else inc.style.display = 'none';

            // Shop UI updates
            document.getElementById('lv-auto').innerText = s.autoLvl;
            document.getElementById('cost-auto').innerText = s.autoLvl >= 6 ? 'MAX' : CONFIG.autoCosts[s.autoLvl];
            
            let tapPrice = CONFIG.tapCosts[s.power - 1] || s.power * 1000;
            document.getElementById('cost-tap').innerText = tapPrice;
            document.getElementById('tap-desc').innerText = `+${s.power} –∑–∞ –∫–ª—ñ–∫`;
            
            document.getElementById('cost-energy').innerText = 100 + ((s.maxEnergy - 200) / 100) * CONFIG.energyStep;
            document.getElementById('lv-regen').innerText = s.regen;
            document.getElementById('cost-regen').innerText = s.regen * CONFIG.regenBase;
        },

        renderTasks: function() {
            const container = document.getElementById('task-list');
            container.innerHTML = '';
            TASKS_DATA.forEach(t => {
                const done = this.state.completedTasks.includes(t.id);
                const div = document.createElement('div');
                div.className = `card ${done ? 'completed' : ''}`;
                div.innerHTML = `
                    <div class="card-info"><h4>${t.text}</h4><p style="color:var(--gold)">+${t.reward}</p></div>
                    <button class="btn-task" ${done ? 'disabled' : `onclick="Shop.doTask(${t.id})"`}>${done ? '‚úÖ' : '–í–∏–∫–æ–Ω–∞—Ç–∏'}</button>
                `;
                container.appendChild(div);
            });
        }
    };

    // --- AUTH CONTROLLER ---
    const Auth = {
        show: function() {
            document.getElementById('main-app-container').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
        },
        attemptLogin: async function() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            const dn = document.getElementById('display-name').value.trim();
            if(!u || !p) return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è");

            try {
                // pass displayName for new registrations
                const res = await Server.login(u, p, dn || null);
                localStorage.setItem('auth_token', res.token);
                if (res.isNew) {
                    // prompt avatar picker for new users (pending holds displayName)
                    document.getElementById('avatar-picker').style.display = 'flex';
                    this._pending = res;
                } else {
                    Game.startGame(res.data, res.token);
                }
            } catch (e) {
                if(e.message === "BANNED") {
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('ban-screen').style.display = 'flex';
                } else {
                    alert("–ü–æ–º–∏–ª–∫–∞: " + e.message);
                }
            }
        },
        uploadAvatar: async function() {
            const fileEl = document.getElementById('avatar-file-input');
            if (!fileEl.files || !fileEl.files[0]) {
                return this.skipAvatar();
            }
            const file = fileEl.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                const pending = this._pending;
                if (pending) {
                    const idx = Server.db.users.findIndex(u => u.username === pending.data.username);
                    if (idx !== -1) {
                        // store avatar and ensure displayName persisted (if provided)
                        Server.db.users[idx].avatar = dataUrl;
                        if(pending.data.displayName) Server.db.users[idx].displayName = pending.data.displayName;
                        Server._saveDb();
                        pending.data.avatar = dataUrl;
                        pending.data.displayName = Server.db.users[idx].displayName;
                        Game.startGame(pending.data, pending.token);
                        document.getElementById('avatar-picker').style.display = 'none';
                        delete this._pending;
                    }
                }
            };
            reader.readAsDataURL(file);
        },
        skipAvatar: function() {
            const pending = this._pending;
            if (pending) {
                // ensure displayName persisted from pending
                const idx = Server.db.users.findIndex(u => u.username === pending.data.username);
                if (idx !== -1 && pending.data.displayName) {
                    Server.db.users[idx].displayName = pending.data.displayName;
                    Server._saveDb();
                    pending.data.displayName = Server.db.users[idx].displayName;
                }
                Game.startGame(pending.data, pending.token);
                document.getElementById('avatar-picker').style.display = 'none';
                delete this._pending;
            }
        },
        logout: function() {
            localStorage.removeItem('auth_token');
            location.reload();
        }
    };

    // --- SHOP & ACTIONS ---
    const Shop = {
        buy: function(type) {
            const s = Game.state;
            let cost = 0;
            let success = false;
            let elId = `card-${type}`;

            if (type === 'tap') {
                cost = CONFIG.tapCosts[s.power - 1] || s.power * 1000;
                if (s.bal >= cost) { s.bal -= cost; s.power++; success = true; }
            } else if (type === 'auto' && s.autoLvl < 6) {
                cost = CONFIG.autoCosts[s.autoLvl];
                if (s.bal >= cost) { s.bal -= cost; s.autoLvl++; success = true; }
            } else if (type === 'energy') {
                cost = 100 + ((s.maxEnergy - 200) / 100) * CONFIG.energyStep;
                if (s.bal >= cost) { s.bal -= cost; s.maxEnergy += 100; s.energy += 100; success = true; }
            } else if (type === 'regen') {
                cost = s.regen * CONFIG.regenBase;
                if (s.bal >= cost) { s.bal -= cost; s.regen++; success = true; }
            }

            const card = document.getElementById(elId);
            if (success) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                card.classList.add('buy-success');
                setTimeout(()=>card.classList.remove('buy-success'), 500);
                Game.updateUI();
                Server.sync(Game.token, Game.state); // Save immediately on purchase
            } else {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                card.classList.add('buy-fail');
                setTimeout(()=>card.classList.remove('buy-fail'), 500);
            }
        },
        doTask: function(id) {
            const task = TASKS_DATA.find(t => t.id === id);
            Game.state.bal += task.reward;
            Game.state.completedTasks.push(id);
            Game.renderTasks();
            Game.updateUI();
            Server.sync(Game.token, Game.state);
        }
    };

    // --- ADMIN CONTROLLER ---
    const Admin = {
        clicks: 0,
        timer: null,
        
        handleSecretClick: function() {
            this.clicks++;
            clearTimeout(this.timer);
            this.timer = setTimeout(() => this.clicks = 0, 2000);
            if (this.clicks >= 5) {
                this.clicks = 0;
                document.getElementById('admin-auth-overlay').style.display = 'flex';
            }
        },
        
        closeOverlay: function() {
            document.getElementById('admin-auth-overlay').style.display = 'none';
            document.getElementById('admin-pass-input').value = '';
        },

        checkAccess: async function() {
            const pass = document.getElementById('admin-pass-input').value;
            if (pass === 'adminroma') {
                document.getElementById('admin-panel').style.display = 'block';
                this.closeOverlay();
                this.refreshList();
            } else {
                alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø—É");
            }
        },

        refreshList: async function() {
            const users = await Server.getAllUsers();
            const tbody = document.getElementById('admin-users-list');
            tbody.innerHTML = '';
            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="${u.isBanned ? 'color:red' : 'color:white'}">${u.username} ${u.isBanned ? '(BAN)' : ''}</td>
                    <td>${Math.floor(u.bal).toLocaleString()}</td>
                    <td>Auto: ${u.autoLvl}</td>
                `;
                tbody.appendChild(tr);
            });
        },

        // now actions apply to the currently logged-in user (Game.state)
        action: async function(act) {
            const amt = parseFloat(document.getElementById('admin-amount-field').value) || 0;
            if (!Game.state) return alert("–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞");
            if (act === 'add') {
                Game.state.bal += amt;
            } else if (act === 'sub') {
                Game.state.bal -= amt;
                if (Game.state.bal < 0) Game.state.bal = 0;
            } else if (act === 'set') {
                Game.state.bal = amt;
            } else if (act === 'ban') {
                if (!confirm("–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ü–µ–π –∞–∫–∞—É–Ω—Ç –Ω–∞–∑–∞–≤–∂–¥–∏?")) return;
                Game.state.isBanned = true;
            }

            Game.updateUI();
            await Server.sync(Game.token, Game.state);
            this.refreshList();

            if (Game.state.isBanned) {
                // persist and show ban screen for currently logged user
                localStorage.removeItem('auth_token');
                document.getElementById('main-app-container').style.display = 'none';
                document.getElementById('ban-screen').style.display = 'flex';
            }
        }
    };

    // --- TABS & CLICKS ---
    const Tabs = {
        show: function(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            el.classList.add('active');
        }
    };

    // Click Handler
    document.getElementById('tap-coin').addEventListener('touchstart', (e) => {
        e.preventDefault();
        const s = Game.state;
        if (s.energy >= s.power) {
            s.bal += s.power;
            s.energy -= s.power;
            
            // Visuals
            const t = e.touches[0];
            const p = document.createElement('div');
            p.className = 'float-text';
            p.innerText = `+${s.power}`;
            p.style.left = t.clientX + 'px';
            p.style.top = t.clientY + 'px';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 700);
            
            Game.updateUI();
        }
    }, {passive: false});

    // Init Telegram & Game
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // Start App
    Game.init();

</script>
</body>
</html>
